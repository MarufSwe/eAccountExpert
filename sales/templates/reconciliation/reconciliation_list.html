{% extends "base.html" %}
{% load static %}

{% block title %}Reconciliation List{% endblock %}

{% block content %}

<style>
    /* Professional Table Styling */
    .reconciliation-table {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }
    
    .table-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 12px 12px 0 0;
    }
    
    .table thead th {
        background: #f8f9fa;
        border: none;
        font-weight: 600;
        color: #495057;
        padding: 15px 12px;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .table tbody td {
        padding: 12px;
        vertical-align: middle;
        border-top: 1px solid #e9ecef;
        font-size: 13px;
    }
    
    .table tbody tr:hover {
        background-color: #f8f9fa;
        transition: all 0.2s ease;
    }
    
    /* Inline Edit Styling */
    .editable-field {
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 4px;
        transition: all 0.2s ease;
        min-height: 24px;
        display: inline-block;
        min-width: 100px;
    }
    
    .editable-field:hover {
        background-color: #e3f2fd;
        border: 1px dashed #2196f3;
    }
    
    .editable-field.empty {
        color: #6c757d;
        font-style: italic;
        background-color: #f8f9fa;
    }
    
    .editable-field.empty:hover {
        background-color: #e9ecef;
        border: 1px dashed #6c757d;
    }
    
    .edit-input {
        width: 100%;
        padding: 4px 8px;
        border: 2px solid #2196f3;
        border-radius: 4px;
        font-size: 13px;
        outline: none;
    }
    
    .edit-buttons {
        display: inline-block;
        margin-left: 5px;
    }
    
    .btn-save, .btn-cancel {
        padding: 2px 8px;
        font-size: 11px;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        margin: 0 2px;
    }
    
    .btn-save {
        background: #28a745;
        color: white;
    }
    
    .btn-cancel {
        background: #dc3545;
        color: white;
    }
    
    /* Summary Cards */
    .summary-card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s ease;
    }
    
    .summary-card:hover {
        transform: translateY(-2px);
    }
    
    .summary-card.reconciled {
        border-left: 4px solid #28a745;
    }
    
    .summary-card.unreconciled {
        border-left: 4px solid #dc3545;
    }
    
    .summary-card .card-header {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border: none;
        font-weight: 600;
    }
    
    .summary-card.unreconciled .card-header {
        background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
    }
    
    /* Action Buttons */
    .action-buttons {
        display: flex;
        gap: 10px;
        align-items: center;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 8px;
        padding: 10px 20px;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    
    .btn-success {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        border: none;
        border-radius: 8px;
        padding: 10px 20px;
        font-weight: 500;
    }
    
    /* Loading States */
    .loading {
        opacity: 0.6;
        pointer-events: none;
    }
    
    .spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
        .table-responsive {
            font-size: 12px;
        }
        
        .editable-field {
            min-width: 80px;
        }
    }

    /* Category field styling */
    .category-field-container {
        min-height: 35px;
        cursor: pointer;
    }

    .category-display {
        padding: 8px 12px;
        border: 1px solid transparent;
        border-radius: 6px;
        transition: all 0.2s ease;
        min-height: 35px;
        display: flex;
        align-items: center;
    }

    .category-display:hover {
        background-color: #f8f9fa;
        border-color: #dee2e6;
    }

    .category-display.empty {
        background-color: #fff3cd;
        border-color: #ffeaa7;
        color: #856404;
    }

    .category-display.empty:hover {
        background-color: #fff3cd;
        border-color: #ffc107;
    }

    .category-text {
        font-weight: 500;
        color: #495057;
    }

    .empty-text {
        color: #856404;
        font-style: italic;
        font-size: 0.9rem;
    }

    .category-edit-mode {
        position: relative;
    }

    /* Select2 customization for inline dropdown */
    .select2-container--bootstrap-5 .select2-selection {
        min-height: 35px;
        border-color: #007bff;
    }

    .select2-container--bootstrap-5 .select2-selection:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
</style>

<div class="container-fluid">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="table-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="mb-1">
                            <i class="fas fa-chart-line me-2"></i>
                            Reconciliation Report
                        </h4>
                        <p class="mb-0 opacity-75">
                            <strong>{{ sales_data.shop.name }}</strong> â€¢ 
                            <i class="fas fa-calendar me-1"></i>{{ sales_data.date_uploaded|date:"M d, Y" }}
                        </p>
                    </div>
                    <div class="action-buttons">
                        <a href="{% url 'sales_data_list' %}" class="btn btn-light">
                            <i class="fas fa-arrow-left me-1"></i> Back to Sales Data
                        </a>
                        <button class="btn btn-success" onclick="generatePLReport()">
                            <i class="fas fa-file-invoice me-1"></i> Generate P&L Report
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    {% if pivot_summary %}
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card summary-card reconciled">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-check-circle me-2"></i>Reconciled Transactions
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="border-end">
                                <h5 class="text-success mb-1">${{ pivot_summary.reconciled.dr|floatformat:2 }}</h5>
                                <small class="text-muted">Total Debit (Dr)</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <h5 class="text-success mb-1">${{ pivot_summary.reconciled.cr|floatformat:2 }}</h5>
                            <small class="text-muted">Total Credit (Cr)</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card summary-card unreconciled">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>Unreconciled Transactions
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="border-end">
                                <h5 class="text-danger mb-1">${{ pivot_summary.unreconciled.dr|floatformat:2 }}</h5>
                                <small class="text-muted">Total Debit (Dr)</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <h5 class="text-danger mb-1">${{ pivot_summary.unreconciled.cr|floatformat:2 }}</h5>
                            <small class="text-muted">Total Credit (Cr)</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Reconciliation Table -->
    <div class="card reconciliation-table">
        <div class="card-body p-0">
            {% if reconciliations %}
                <div class="table-responsive">
                    <table class="professional-table table-hover mb-0">
                        <thead>
                            <tr>
                                <th width="5%">#</th>
                                <th width="35%">
                                    <i class="fas fa-align-left me-1"></i>Description
                                </th>
                                <th width="10%" class="text-center">
                                    <i class="fas fa-coins me-1"></i>Amount
                                </th>
                                <th width="20%">
                                    <i class="fas fa-filter me-1"></i>Slicer New
                                    <!-- <small class="text-muted d-block">Click to edit</small> -->
                                </th>
                                <th width="20%">
                                    <i class="fas fa-tags me-1"></i>Category New
                                    <!-- <small class="text-muted d-block">Click to edit</small> -->
                                </th>
                                <th width="10%" class="text-center">
                                    <i class="fas fa-arrow-down text-success me-1"></i>Credit
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for reconciliation in reconciliations %}
                                <tr>
                                    <td class="text-muted">{{ forloop.counter }}</td>
                                    <td>
                                        <div class="text-truncate" style="max-width: 300px;" title="{{ reconciliation.description }}">
                                            {{ reconciliation.description }}
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge {% if reconciliation.amount < 0 %}bg-danger{% else %}bg-success{% endif %}">
                                            ${{ reconciliation.amount|floatformat:2 }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="editable-field {% if not reconciliation.slicer_new.strip %}empty{% endif %}" 
                                             data-field="slicer_new" 
                                             data-id="{{ reconciliation.id }}"
                                             data-value="{{ reconciliation.slicer_new|default:'' }}">
                                            {% if reconciliation.slicer_new.strip %}
                                                {{ reconciliation.slicer_new }}
                                            {% else %}
                                                Click to add slicer
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="category-field-container" 
                                             data-id="{{ reconciliation.id }}"
                                             data-value="{{ reconciliation.category_new|default:'' }}">
                                            
                                            <!-- Display Mode -->
                                            <div class="category-display {% if not reconciliation.category_new.strip %}empty{% endif %}">
                                                {% if reconciliation.category_new.strip %}
                                                    <span class="category-text">{{ reconciliation.category_new }}</span>
                                                {% else %}
                                                    <span class="empty-text">Click to select category</span>
                                                {% endif %}
                                            </div>
                                            
                                            <!-- Edit Mode (hidden by default) -->
                                            <div class="category-edit-mode" style="display: none;">
                                                <select class="category-select form-select" style="width: 100%;">
                                                    <option value="">-- Select Category --</option>
                                                    {% for category in all_category_options %}
                                                        <option value="{{ category }}" {% if category == reconciliation.category_new %}selected{% endif %}>{{ category }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <div class="d-flex justify-content-center">
                                            <span class="text-success fw-bold">${{ reconciliation.credit_amount|floatformat:2 }}</span>
                                        </div>
                                        <div class="text-danger fw-bold">${{ reconciliation.debit_amount|floatformat:2 }}</div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No reconciliations available</h5>
                    <p class="text-muted">Upload and reconcile some sales data first.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle category field clicks for inline editing
    document.addEventListener('click', function(e) {
        // Handle category field clicks
        if (e.target.closest('.category-display')) {
            e.preventDefault();
            
            const container = e.target.closest('.category-field-container');
            const displayMode = container.querySelector('.category-display');
            const editMode = container.querySelector('.category-edit-mode');
            const select = container.querySelector('.category-select');
            
            // Switch to edit mode
            displayMode.style.display = 'none';
            editMode.style.display = 'block';
            
            // Initialize Select2 for this specific dropdown
            $(select).select2({
                theme: 'bootstrap-5',
                placeholder: '-- Select Category --',
                allowClear: true,
                width: '100%'
            });
            
            // Focus and open the dropdown
            $(select).select2('open');
            
            // Handle selection
            $(select).on('select2:select', function(e) {
                const selectedValue = e.params.data.id;
                const reconciliationId = container.dataset.id;
                
                // Save to database
                saveCategoryField(reconciliationId, selectedValue, container);
            });
            
            // Handle close without selection
            $(select).on('select2:close', function(e) {
                const selectedValue = $(this).val();
                if (!selectedValue) {
                    // No selection made, revert to display mode
                    revertToDisplayMode(container);
                }
            });
        }
        
        // Handle editable field clicks (for Slicer New - keep existing functionality)
        else if (e.target.closest('.editable-field') && !e.target.closest('.edit-input') && !e.target.closest('.edit-buttons')) {
            const field = e.target.closest('.editable-field');
            if (!field.querySelector('.edit-input')) {
                makeEditable(field);
            }
        }
        
        // Handle save button clicks
        if (e.target.closest('.btn-save')) {
            const button = e.target.closest('.btn-save');
            const field = button.closest('.editable-field');
            const input = field.querySelector('.edit-input');
            const fieldId = field.dataset.id;
            const fieldName = field.dataset.field;
            saveField(fieldId, fieldName, input.value, field);
        }
        
        // Handle cancel button clicks
        if (e.target.closest('.btn-cancel')) {
            const button = e.target.closest('.btn-cancel');
            const field = button.closest('.editable-field');
            const originalValue = field.dataset.value || '';
            cancelEdit(field, originalValue);
        }
    });
});

function makeEditable(field) {
    if (field.querySelector('.edit-input')) return; // Already in edit mode
    
    const currentValue = field.dataset.value || '';
    const fieldName = field.dataset.field;
    const fieldId = field.dataset.id;
    
    // Create input field
    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'edit-input';
    input.value = currentValue;
    
    // Create buttons
    const buttonContainer = document.createElement('div');
    buttonContainer.className = 'edit-buttons';
    
    const saveBtn = document.createElement('button');
    saveBtn.className = 'btn-save';
    saveBtn.innerHTML = '<i class="fas fa-check"></i>';
    saveBtn.type = 'button';
    
    const cancelBtn = document.createElement('button');
    cancelBtn.className = 'btn-cancel';
    cancelBtn.innerHTML = '<i class="fas fa-times"></i>';
    cancelBtn.type = 'button';
    
    buttonContainer.appendChild(saveBtn);
    buttonContainer.appendChild(cancelBtn);
    
    // Replace content
    field.innerHTML = '';
    field.appendChild(input);
    field.appendChild(buttonContainer);
    
    // Focus and select the input
    input.focus();
    input.select();
    
    // Handle Enter key for save
    input.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            saveField(fieldId, fieldName, input.value, field);
        }
    });
    
    // Handle Escape key for cancel
    input.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            e.preventDefault();
            cancelEdit(field, currentValue);
        }
    });
}

function saveField(reconciliationId, fieldName, value, fieldElement) {
    fieldElement.classList.add('loading');
    
    fetch(`/dashboard/reconciliation/${reconciliationId}/update/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: `field_name=${fieldName}&field_value=${encodeURIComponent(value)}`
    })
    .then(response => response.json())
    .then(data => {
        fieldElement.classList.remove('loading');
        
        if (data.success) {
            // Update the field display
            fieldElement.dataset.value = value;
            fieldElement.innerHTML = value || 'Click to add ' + fieldName.replace('_', ' ');
            fieldElement.classList.toggle('empty', !value.trim());
            
            // Show success message
            showNotification('Field updated successfully!', 'success');
        } else {
            showNotification('Error: ' + data.error, 'error');
            // Revert to original value
            const originalValue = fieldElement.dataset.value || '';
            fieldElement.innerHTML = originalValue || 'Click to add ' + fieldName.replace('_', ' ');
            fieldElement.classList.toggle('empty', !originalValue.trim());
        }
    })
    .catch(error => {
        fieldElement.classList.remove('loading');
        showNotification('Network error occurred', 'error');
        console.error('Error:', error);
        
        // Revert to original value
        const originalValue = fieldElement.dataset.value || '';
        fieldElement.innerHTML = originalValue || 'Click to add ' + fieldName.replace('_', ' ');
        fieldElement.classList.toggle('empty', !originalValue.trim());
    });
}

function cancelEdit(field, originalValue) {
    // Simply restore the original content
    field.innerHTML = originalValue || 'Click to add ' + field.dataset.field.replace('_', ' ');
    field.classList.toggle('empty', !originalValue.trim());
    // No need to re-add event listeners since we're using event delegation
}

function generatePLReport() {
    // Check if there are unreconciled transactions
    const unreconciledCount = document.querySelectorAll('.editable-field.empty').length;
    
    if (unreconciledCount > 0) {
        if (!confirm(`You have ${unreconciledCount} unreconciled transactions. Do you want to generate P&L report anyway?`)) {
            return;
        }
    }
    
    // Redirect to P&L report
    window.location.href = "{% url 'pl_report' sales_data.id %}";
}

function showNotification(message, type) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 80px; right: 20px; z-index: 10000; min-width: 300px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 3000);
}

// Helper function to save category field
function saveCategoryField(reconciliationId, selectedValue, container) {
    // Show loading state
    const editMode = container.querySelector('.category-edit-mode');
    editMode.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Saving...</div>';
    
    // Save to database
    fetch(`/dashboard/reconciliation/${reconciliationId}/update/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: `field_name=category_new&field_value=${encodeURIComponent(selectedValue)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update container data
            container.dataset.value = selectedValue;
            
            // Update display mode
            const displayMode = container.querySelector('.category-display');
            displayMode.classList.remove('empty');
            displayMode.innerHTML = `<span class="category-text">${selectedValue}</span>`;
            
            // Switch back to display mode
            revertToDisplayMode(container);
            
            // Show success notification
            showNotification('Category updated successfully!', 'success');
        } else {
            showNotification('Error: ' + (data.error || 'Failed to update category'), 'error');
            revertToDisplayMode(container);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Network error occurred', 'error');
        revertToDisplayMode(container);
    });
}

// Helper function to revert to display mode
function revertToDisplayMode(container) {
    const displayMode = container.querySelector('.category-display');
    const editMode = container.querySelector('.category-edit-mode');
    const select = container.querySelector('.category-select');
    
    // Destroy Select2 instance
    if ($(select).hasClass('select2-hidden-accessible')) {
        $(select).select2('destroy');
    }
    
    // Reset edit mode HTML
    const currentValue = container.dataset.value;
    editMode.innerHTML = `
        <select class="category-select form-select" style="width: 100%;">
            <option value="">-- Select Category --</option>
            {% for category in all_category_options %}
                <option value="{{ category }}" ${currentValue === '{{ category }}' ? 'selected' : ''}>{{ category }}</option>
            {% endfor %}
        </select>
    `;
    
    // Switch back to display mode
    displayMode.style.display = 'block';
    editMode.style.display = 'none';
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

{% endblock %}